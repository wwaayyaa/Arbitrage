<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        .el-table .danger-cell {
            background: #f5bec9;
        }

        .el-table .success-cell {
            background: #f0f9eb;
        }

        .el-table h1, h5 {
            margin: 3px;
        }

        .container {
            padding: 1vw;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-right: -50%;
            transform: translate(-50%, -50%);
        }

        .background-color h1 {
            color: #000;
            font-family: 'montserrat';
            font-size: 2vw;
            font-weight: bold;
            /*letter-spacing: 1vw;*/
            max-width: 700px;
            /*text-align: center;*/
            background: rgba(255, 253, 160, 1);
            background: -webkit-linear-gradient(left, #00ffff 0%, #97fba0 25%, #97b1fb 50%, #00ffff 100%) repeat;
            -webkit-background-clip: text;
            -ms-background-clip: text;
            -moz-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            -ms-text-fill-color: transparent;
            -moz-text-fill-color: transparent;
            text-fill-color: transparent;
            -webkit-animation-name: masked-animation;
            -webkit-animation-duration: 50s;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-timing-function: linear;
        }

        @-webkit-keyframes masked-animation {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: -8000px -3000px;
            }
        }
    </style>

</head>
<body>
<div id="app">
    <el-row>
        <el-col :span="24"><h3>价格监控</h3></el-col>
    </el-row>
    <div style="display: flex; flex-wrap: wrap">
        <div v-for="q in quote" style="height: 100px; width: 200px;background: #97b1fb;margin: 10px;padding: 5px"
             @click="select($event, q)">
            <div>{{q.name}} - {{q.exchange}}</div>
            <div>{{q.price}}</div>
            <div>{{q.selected ? '中' : ''}}</div>
        </div>
    </div>
    <div>
        <el-input placeholder="几天" v-model="refreshDays"></el-input>
        <template>
            <el-radio v-model="indexType" label="none">无</el-radio>
            <el-radio v-model="indexType" label="arbitrage">搬砖套利</el-radio>
            <el-radio v-model="indexType" label="triangular_arbitrage">三角套利</el-radio>
        </template>
        <el-button @click="refreshChart" type="primary">画图</el-button>
    </div>
    <div id="chart" style="width: 1000px;height:600px;"></div>
</div>
</body>
<!-- import Vue before Element -->
<script src="https://unpkg.com/vue/dist/vue.js"></script>
<!-- import JavaScript -->
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/dist/echarts.min.js"></script>
<script src="/s/socket.io.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/dayjs/1.4.1/dayjs.min.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    //给定exchange列表
    let priceData = [];
    let pushData = function (exchangeName, quoteName, price) {
        let key = `${exchangeName}-${quoteName}`;
        priceData[key] = price;
        this.$data.quote.forEach((e, i) => {
            if (e.exchange == exchangeName && e.name == quoteName) {
                this.$data.quote[i].price = price;
            }
        });
    };
    let socket = io(window.location.host, {path: '/s'});

    let vue = new Vue({
        el: '#app',
        data: function () {
            return {
                chartVisible: false,
                quote: [],

                selected: [],
                refreshing: false,
                refreshDays: 1,
                indexType: 'none',
            }
        },
        methods: {
            pushData: pushData,
            chart(event, pairName) {
                console.log(event, pairName);
                this.$data.chartVisible = true;

                socket.emit('history', pairName);
            },
            select(e, info) {
                // console.log(info.id);
                let id = info.id;
                let find = vue.$data.selected.find(s => s.id == info.id);
                if (find){
                    let index = vue.$data.selected.findIndex(s => s.id == info.id);
                    vue.$data.selected = vue.$data.selected.filter(s => s.id != info.id);
                    vue.$data.quote = vue.$data.quote.map(q => {if(q.id == id){q.selected = false;}return q;});
                }else{
                    vue.$data.selected.push(info);
                    vue.$data.quote = vue.$data.quote.map(q => {if(q.id == id){q.selected = true;}return q;});
                }
            },
            async refreshChart(){
                this.$data.refreshing = true;
                var myChart = echarts.init(document.getElementById('chart'));
                myChart.clear();
                legendData = [];
                xAxisData = [];
                seriesData = [];
                if (vue.$data.refreshDays > 30 || vue.$data.refreshDays < 1){
                    alert('天数只能在1~30天之内');
                    return;
                }
                for(let i = 0; i< vue.$data.selected.length; i++){
                    let selected = vue.$data.selected[i];
                    let exchangeName = selected.exchange;
                    let symbol = selected.name.replace('\/','-');
                    let limit = 1440 * vue.$data.refreshDays;
                    let response = await axios.get(`/api/minute_history?exchange_name=${exchangeName}&symbol=${symbol}&limit=${limit}`);
                    let legendName = `${selected.name}-${selected.exchange}`;
                    legendData.push(legendName);
                    xAxisData = response.data.map(r => r.minute);
                    seriesData.push({
                        symbol: "none",
                        name: legendName,
                        type: 'line',
                        data: response.data.map(r => r.price)
                    });
                        // .then(response =>{
                        //     console.log(response.data);
                        // })
                        // .catch(e => {
                        //     console.error('get history error:', e)
                        // });
                }

                if(seriesData.length >= 2 && vue.$data.indexType == 'arbitrage'){
                    console.log('@!#!@#');
                    let rateData = [];
                    //计算比例
                    for(let i = 0; i<xAxisData.length;i++){
                        let min = 0;
                        let max = 0;
                        for(let j = 0; j <seriesData.length; j++){
                            let price = seriesData[j].data[i];
                            if(price != null){
                                if(min == 0) {min = price};
                                if(max == 0) {max = price};
                                if(price < min){
                                    min = price;
                                }
                                if(price > max){
                                    max = price;
                                }
                            }
                        }
                        rateData.push((max / min - 1) * 100);
                    }
                    // console.log(rateData);
                    legendData.push('价差比例%');
                    seriesData.push({
                        symbol: "none",
                        name: '价差比例%',
                        type: 'bar',
                        yAxisIndex: 1,
                        data: rateData
                    });
                }
                if(seriesData.length == 3 && vue.$data.indexType == 'triangular_arbitrage'){
                    //TODO
                }

                var option = {
                    title: {
                        text: ''
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'cross',
                            label: {
                                backgroundColor: '#283b56'
                            }
                        }
                    },
                    dataZoom: [{
                        type: 'inside',
                        start: 0,
                        end: 100
                    }, {
                        start: 0,
                        end: 10,
                        handleIcon: 'M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                        handleSize: '80%',
                        handleStyle: {
                            color: '#fff',
                            shadowBlur: 3,
                            shadowColor: 'rgba(0, 0, 0, 0.6)',
                            shadowOffsetX: 2,
                            shadowOffsetY: 2
                        }
                    }],
                    legend: {
                        data: legendData
                    },
                    xAxis: {
                        data: xAxisData // data.history.map(r => dayjs(r.timestamp * 1000).format('MM-DD HH:mm'))
                    },
                    yAxis: [{
                        type: 'value',
                        scale: true,
                        name: '价格',
                        boundaryGap: [0.2, 0.2]
                    },
                        {
                            type: 'value',
                            scale: true,
                            name: '价差%',
                            max: 3,
                            min: 0,
                            boundaryGap: [0.2, 0.2]
                        }],
                    series: seriesData
                };

                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);
                this.$data.refreshing = false;
            }
        },
        mounted: function () {
            let _self = this;
            // console.log('mounted');
            axios.get('/api/quote')
                .then(response => {
                    response.data.map(q => {
                        q.price = '-';
                        q.selected = false;
                        return q;
                    });
                    _self.$data.quote = response.data;
                    socket.emit('init');
                })
                .catch(err => {
                    console.error(err)
                })
        }
    });

    socket.on('init_price', data => {
        // console.log('~', data);
        for (let i in data) {
            [en, s] = i.split('_');
            pushData(en, s, data[i]);
        }
    });
    socket.on('price', data => {
        //把价格转换成二维数组中的一个元素
        vue.pushData(data.exchangeName, data.quoteName, data.price);
    });

    let legendData = [];
    let xAxisData = [];
    let seriesData = [];
    // [{
    //     symbol: "none",
    //     name: 'uniswap',
    //     type: 'line',
    //     data: data.history.map(r => r.univ2Price)
    // }, {
    //     symbol: "none",
    //     name: 'sushiswap',
    //     type: 'line',
    //     data: data.history.map(r => r.sushiPrice)
    // }, {
    //     symbol: "none",
    //     name: '价差%',
    //     type: 'bar',
    //     yAxisIndex: 1,
    //     data: data.history.map(r => r.arbitrageRate)
    // }];

</script>
</html>
